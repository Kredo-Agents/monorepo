# OpenClaw Docker Image
# Based on official OpenClaw documentation: https://docs.openclaw.ai/install/docker

FROM node:22-bookworm

# Install Bun (required for OpenClaw build scripts)
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

# Install pnpm for OpenClaw scripts
RUN corepack enable && corepack prepare pnpm@latest --activate


# Set working directory
WORKDIR /app

# Clone OpenClaw repository
RUN git clone https://github.com/openclaw/openclaw.git . && \
    git checkout main

# Install dependencies
RUN bun install

# Build OpenClaw
RUN bun run build && \
    bun run ui:install && \
    bun run ui:build

# Install Python and Aider for AI coding assistance
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Install Aider
RUN pip3 install --no-cache-dir --break-system-packages aider-chat

# Verify aider installation
RUN aider --version

# Set production environment
ENV NODE_ENV=production

# Create default directories
RUN mkdir -p /home/node/.openclaw/workspace/skills

# Expose gateway port
EXPOSE 18789

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD node dist/index.js health || exit 1

# Default command (will be overridden by docker-compose)
CMD ["node", "dist/index.js", "gateway", "--port", "18789", "--bind", "0.0.0.0"]
